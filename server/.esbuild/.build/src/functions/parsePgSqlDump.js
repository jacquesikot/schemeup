var N=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var j=(m,c)=>{for(var u in c)N(m,u,{get:c[u],enumerable:!0})},V=(m,c,u,x)=>{if(c&&typeof c=="object"||typeof c=="function")for(let f of z(c))!B.call(m,f)&&f!==u&&N(m,f,{get:()=>c[f],enumerable:!(x=v(c,f))||x.enumerable});return m};var J=m=>V(N({},"__esModule",{value:!0}),m);var G={};j(G,{handler:()=>$});module.exports=J(G);var L=["int","integer","bigint","smallint","decimal","numeric","real","double precision","serial","bigserial","money","character varying","varchar","character","char","text","bytea","timestamp without time zone","timestamp with time zone","date","time without time zone","time with time zone","interval","boolean","enum","uuid","json","jsonb","xml","tsvector","tsquery","point","line","lseg","box","path","polygon","circle","cidr","inet","macaddr","bit","bit varying","hstore","ltree","ltxtquery"];var $=async m=>{let c=m.body,u=c;u=c.replace(/--.*$/gm,""),u=u.replace(/\/\*[\s\S]*?\*\//gm,"");let f=u.replace(/\n/g," ").replace(/\s+/g," ").trim().toLowerCase().split(";");f=f.filter(s=>s.trim()!=="");let K=[];function S(s){return s.filter(r=>/CREATE TABLE[^;]+/gi.test(r))}function F(s){let a=[],r=s.indexOf("(")+1,o=s.lastIndexOf(")"),e=s.substring(r,o).trim();for(let t of e){let n=t.split(" ")[0];(n.toLowerCase()==="primary"||n.toLowerCase()==="foreign"||n.toLowerCase()==="constraint"||n.toLowerCase()==="check"||n.toLowerCase()==="unique"||n.toLowerCase()==="index"||n.toLowerCase()==="using"||n.toLowerCase()==="tablespace"||n.toLowerCase()==="inherits"||n.toLowerCase()==="with"||n.toLowerCase()==="options"||n.toLowerCase()==="storage"||n.toLowerCase()==="collate"||n.toLowerCase()==="default"||n.toLowerCase()==="generated"||n.toLowerCase()==="identity"||n.toLowerCase()==="always"||n.toLowerCase()==="as"||n.toLowerCase()==="stored"||n.toLowerCase()==="virtual"||n.toLowerCase()==="on"||n.toLowerCase()==="delete"||n.toLowerCase()==="update"||n.toLowerCase()==="references"||n.toLowerCase()==="match"||n.toLowerCase()==="partial")&&(e=e.replace(t,""))}let i=0,l="";for(let t=0;t<e.length;t++){let n=e[t];n==="("?i++:n===")"&&i--,n===","&&i===0?(a.push(l.trim()),l=""):l+=n}return a.push(l.trim()),a}function M(s){let a="";for(let r=0;r<L.length;r++){let o=new RegExp(L[r]+"\\b[^\\s]*","i"),e=s.match(o);e&&(!a||e[0].length>a.length)&&(a=e[0])}return a}function O(s){return s.map(a=>{let o=a.split(" ")[0].replace(/"/g,""),e=M(a),i=!a.includes("not null"),l=a.includes("primary key"),t=a.includes("unique"),n=/comment\s+'(.*)'/i,g=a.match(n),p=g?g[1]:void 0,d=a.includes("index"),b=/default\s+(.*)/i,h=a.match(b),y=h?h[1]:void 0;return{name:o,type:e,nullable:i,primaryKey:l,unique:t,comment:p,index:d,default:y}})}function A(s){let a=/alter table[^;]+;/gi;return u.match(a)||[]}function I(s){let a=[];return s.forEach(r=>{let o=r.toLowerCase().replace(/\n/g," ").replace(/\s+/g," ").trim();if(o.includes("add constraint")&&o.includes("foreign key")){let e=o.match(/alter table only (.*?) add constraint/),i=o.match(/add constraint (.*?) foreign key/),l=o.match(/foreign key \((.*?)\) references/),t=o.match(/references (.*?)\(/),n=o.match(/references .*?\((.*?)\)/),g=o.match(/on update (cascade|set null|set default|no action)/),p=o.match(/on delete (cascade|set null|set default|no action)/);if(e&&i&&l&&t&&n){let d=e[1],b=i[1],h=l[1],y=t[1],C=n[1],D=g?g[1]:"NO ACTION",P=p?p[1]:"NO ACTION",w=a.find(U=>U.tableName===d);w||(w={tableName:d,foreignKeys:[]},a.push(w)),w.foreignKeys.push({name:b,column:h,referenceTable:y,referenceColumn:C,onUpdate:D,onDelete:P})}}}),a}function q(s){let a=[];return T.forEach(r=>{r=r.toLowerCase(),r=r.replace(/\s+/g," "),r=r.replace(/[\r\n]+/g,""),r=r.replace(/"/g,"");let o=r.match(/create table (\w+\.\w+)/),e=o?o[1]:"NO TABLE NAME",i=/(constraint (\w+) )?foreign key \((\w+)\) references (\w+\.\w+)( \((\w+)\))?( on delete (cascade|set null|no action|restrict|set default))?( on update (cascade|set null|no action|restrict|set default))?/g,l,t=[];for(;(l=i.exec(r))!==null;){let n={name:"",column:l[3]||"",referenceTable:l[4]||"",referenceColumn:l[6]||"NO COLUMN",onDelete:l[8]||"NO ACTION",onUpdate:l[10]||"NO ACTION"};t.push(n)}t.length>0&&a.push({tableName:e,foreignKeys:t})}),a}function E(s){s=s.toLowerCase().replace(/"/g,"").replace(/\s+/g," ").trim();let a=s.split(";"),r={},o=/create (unique )?index (.*?) on (.*?) using (.*?) \((.*?)\)/;for(let e of a){let i=e.match(o);if(i){let l=!!i[1],t=i[2],n=i[3],g=i[4],p=i[5];r[n]||(r[n]={tableName:n,indexes:[]}),r[n].indexes.push({column:p,unique:l,sorting:g})}}return r=Object.values(r),r}function R(s){var r,o;let a=[];for(let e of s){let i=/CREATE TABLE\s+((\w+\.\w+)|(\w+\."\w+"))/i,l=e.match(i),t=l?l[1]:"",n=F(e),g=O(n),p=A(m.body),d=I(p),b=q(s),h=d.concat(b),y=E(m.body);a.push({name:t,columns:g,foreignKeys:((r=h.find(C=>C.tableName===t))==null?void 0:r.foreignKeys)||[],indexes:((o=y.find(C=>C.tableName===t))==null?void 0:o.indexes)||[]})}return K=a,a}let T=S(f),k=R(T);return{statusCode:200,body:JSON.stringify({data:k})}};0&&(module.exports={handler});
